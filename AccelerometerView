//
//  AccelerometerView.swift
//  test sound
//
//  Created by é½‹è—¤ç§€å¹³ on 2024/12/22.
//

import SwiftUI
import Charts
import AppTrackingTransparency
import AdSupport
import GoogleMobileAds
// import StoreKit  // â† å‰Šé™¤

struct AccelerometerView: View {
    @StateObject private var viewModel = AccelerometerViewModel()
    @State private var isSettingsPresented = false
    @EnvironmentObject var languageManager: AppLanguageManager
    // @EnvironmentObject var subManager: SubscriptionManager  // â† å‰Šé™¤
    @State private var flashOpacity: Double = 0.0
    @State private var isSharing = false
    @State private var sharedURL: URL?
    @State private var isUserGuidePresented = false // ä½¿ç”¨æ–¹æ³•PDFè¡¨ç¤ºç”¨
    // @State private var isSubscriptionPresented = false   // â† å‰Šé™¤
    
    private var isDayTime: Bool {
        let hour = Calendar.current.component(.hour, from: Date())
        return hour >= 6 && hour < 18
    }
    
    private var backgroundImageName: String {
        isDayTime ? "background1" : "background2"
    }
    
    var body: some View {
        GeometryReader { geo in
            ZStack {
                // èƒŒæ™¯ç”»åƒ
                Image(viewModel.isMeasuring || viewModel.isPaused ? backgroundImageName : "start")
                    .resizable()
                
                // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
                Color.white
                    .opacity(flashOpacity)
                    .animation(.easeInOut(duration: 0.1), value: flashOpacity)
                    .edgesIgnoringSafeArea(.all)
                
                VStack(spacing: geo.size.height * 0.02) {
                    if !viewModel.isMeasuring && !viewModel.isPaused && viewModel.accelerationData.isEmpty {
                        
                        // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢
                        Spacer()
                        
                        VStack(spacing: geo.size.height * 0.02) {
                            Spacer()
                            
                            // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
                            Button(action: {
                                ButtonSoundPlayer.shared.play(soundName: "click1")
                                viewModel.startMeasurement()
                            }) {
                                Text(languageManager.localizedString(for: "startMeasurement"))
                                    .font(.custom("Kazesawa-Bold", size: 35))
                                    .frame(maxWidth: .infinity, minHeight: 44)
                                    .padding()
                                    .background(Color.red.opacity(0.8))
                                    .foregroundColor(.white)
                                    .cornerRadius(10)
                            }
                            .padding(.horizontal)

                            // è¨­å®šãƒœã‚¿ãƒ³
                            Button(action: {
                                ButtonSoundPlayer.shared.play(soundName: "click2")
                                isSettingsPresented = true
                            }) {
                                Text(languageManager.localizedString(for: "settings"))
                                    .font(.custom("Kazesawa-Bold", size: 25))
                                    .frame(maxWidth: .infinity, minHeight: 30)
                                    .padding()
                                    .background(Color.white.opacity(0.8))
                                    .foregroundColor(.black)
                                    .cornerRadius(10)
                            }
                            .padding(.horizontal)
                        }
                        
                        Button(action: {
                            ButtonSoundPlayer.shared.play(soundName: "click2")
                            isUserGuidePresented = true
                        }) {
                            Text(languageManager.localizedString(for: "userGuide"))
                                .font(.custom("Kazesawa-Bold", size: 25))
                                .frame(maxWidth: .infinity, minHeight: 30)
                                .padding()
                                .background(Color.white.opacity(0.8))
                                .foregroundColor(.black)
                                .cornerRadius(10)
                        }
                        .padding(.horizontal)
                        
                        Spacer()
                        
                        // AdMobãƒãƒŠãƒ¼åºƒå‘Šï¼ˆã‚µãƒ–ã‚¹ã‚¯æ¡ä»¶ãªã—ã§å¸¸ã«è¡¨ç¤ºï¼‰
                        AdBannerView(adUnitID: "ca-app-pub-7266216351091418/9893516864")
                            .frame(maxWidth: .infinity)
                            .frame(height: 65)
                            .padding(.bottom, 0)
                        
                    } else {
                        // è¨ˆæ¸¬ä¸­ã¾ãŸã¯åœæ­¢ä¸­ã®ç”»é¢
                        VStack(spacing: geo.size.height * 0.02) {
                            // ä¸Šéƒ¨ãƒãƒŠãƒ¼ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
                            AdBannerView(adUnitID: "ca-app-pub-7266216351091418/1706785524")
                                .frame(maxWidth: .infinity)
                                .frame(height: 65)
                                .padding(.bottom, 0)
                           
                            // çµŒéæ™‚é–“è¡¨ç¤º
                            Text("\(languageManager.localizedString(for: "elapsedTime")): \(formattedElapsedTime(viewModel.elapsedTime))")
                                .font(.custom("Kazesawa-Bold", size: 18))
                                .foregroundColor(.white)
                                .frame(maxWidth: .infinity, alignment: .leading)
                                .padding(.horizontal)
                            
                            // ã‚°ãƒ©ãƒ•è¡¨ç¤º
                            Chart {
                                ForEach(viewModel.accelerationData, id: \.time) { data in
                                    LineMark(
                                        x: .value("æ™‚é–“", data.time),
                                        y: .value("åŠ é€Ÿåº¦ (Zè»¸)", data.z)
                                    )
                                    .interpolationMethod(.catmullRom)
                                    .foregroundStyle(Color.yellow)
                                }
                                
                                // é–¾å€¤ï¼ˆèµ¤ç·šï¼‰
                                RuleMark(y: .value("é–¾å€¤ (æ­£)", viewModel.threshold))
                                    .lineStyle(StrokeStyle(lineWidth: 1, dash: [5]))
                                    .foregroundStyle(Color.red.opacity(0.7))
                                
                                RuleMark(y: .value("é–¾å€¤ (è² )", -viewModel.threshold))
                                    .lineStyle(StrokeStyle(lineWidth: 1, dash: [5]))
                                    .foregroundStyle(Color.red.opacity(0.7))
                            }
                            .chartXScale(domain: getXScaleDomain())
                            .chartYAxis {
                                AxisMarks(position: .leading) { _ in
                                    AxisGridLine().foregroundStyle(.white)
                                    AxisTick().foregroundStyle(.white)
                                    AxisValueLabel().foregroundStyle(.white)
                                }
                            }
                            .chartXAxis {
                                AxisMarks(position: .bottom) { value in
                                    AxisGridLine().foregroundStyle(.white)
                                    AxisTick().foregroundStyle(.white)
                                    if let seconds = value.as(Double.self) {
                                        let minutes = Int(seconds) / 60
                                        let secs = Int(seconds) % 60
                                        AxisValueLabel {
                                            Text("\(minutes):\(String(format: "%02d", secs))")
                                                .foregroundColor(.white)
                                        }
                                    }
                                }
                            }
                            .frame(height: geo.size.height * 0.3)
                            .padding(.horizontal, geo.size.width * 0.07)
                            .clipped()
                            
                            // ç›´è¿‘ãƒ’ãƒƒãƒˆã®è¡¨ç¤ºï¼ˆãã®ã¾ã¾ï¼‰
                            if !viewModel.hitTimestamps.isEmpty {
                                HStack {
                                    ForEach(viewModel.hitTimestamps.suffix(2), id: \.self) { timestamp in
                                        Text("âš ï¸ \(timestamp)")
                                            .font(.custom("Kazesawa-Bold", size: 14))
                                            .foregroundColor(.white)
                                            .multilineTextAlignment(.center)
                                            .padding(6)
                                            .background(Color.black.opacity(0.6))
                                            .overlay(
                                                RoundedRectangle(cornerRadius: 8)
                                                    .stroke(Color.white, lineWidth: 1)
                                            )
                                    }
                                }
                            }
                            
                            // é–¾å€¤ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
                            VStack(spacing: 8) {
                                // ãƒ©ãƒ™ãƒ«ï¼ˆä¸­å¤®ï¼‰
                                Text("\(languageManager.localizedString(for: "threshold")): \(viewModel.threshold, specifier: "%.2f")")
                                    .font(.custom("Kazesawa-Bold", size: 15))
                                    .foregroundColor(.white)
                                    .frame(maxWidth: .infinity, alignment: .center)
                                    .padding(.top, 4)

                                // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨å·¦å³ãƒ©ãƒ™ãƒ«
                                HStack {
                                    Text(languageManager.localizedString(for: "thresholdSensitivityHigh"))
                                        .font(.custom("Kazesawa-Bold", size: 12))
                                        .foregroundColor(.white)

                                    Slider(value: $viewModel.threshold, in: 0.0...2.0)
                                        .accentColor(.blue)

                                    Text(languageManager.localizedString(for: "thresholdSensitivityLow"))
                                        .font(.custom("Kazesawa-Bold", size: 12))
                                        .foregroundColor(.white)
                                }
                            }
                            .padding(.horizontal)
                            
                            // è¨ˆæ¸¬ä¸­ã®ãƒœã‚¿ãƒ³ç¾¤
                            if viewModel.isMeasuring {
                                Button(action: {
                                    ButtonSoundPlayer.shared.play(soundName: "click2")
                                    viewModel.pauseMeasurement()
                                }) {
                                    Text(languageManager.localizedString(for: "pauseMeasurement"))
                                        .font(.custom("Kazesawa-Bold", size: 30))
                                        .frame(maxWidth: .infinity, minHeight: 25)
                                        .padding()
                                        .background(Color.red)
                                        .foregroundColor(.white)
                                        .cornerRadius(10)
                                }
                                .padding(.horizontal)
                                
                                Button(action: {
                                    ButtonSoundPlayer.shared.play(soundName: "click2")
                                    viewModel.startAutoAdjustment()
                                }) {
                                    Text(viewModel.isAutoAdjusting
                                         ? languageManager.localizedString(for: "adjusting")
                                         : languageManager.localizedString(for: "autoAdjustThreshold"))
                                        .font(.custom("Kazesawa-Bold", size: 30))
                                        .frame(maxWidth: .infinity, minHeight: 25)
                                        .padding()
                                        .background(viewModel.isAutoAdjusting ? Color.gray : Color.blue)
                                        .foregroundColor(.white)
                                        .cornerRadius(10)
                                }
                                .disabled(viewModel.isAutoAdjusting)
                                .padding(.horizontal)
                                
                                // ä¸‹éƒ¨ãƒãƒŠãƒ¼ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
                                AdBannerView(adUnitID: "ca-app-pub-7266216351091418/9247785079")
                                    .frame(maxWidth: .infinity)
                                    .frame(height: 65)
                                    .padding(.bottom, 0)
                            }
                            
                            // åœæ­¢ä¸­ã®ãƒœã‚¿ãƒ³ç¾¤
                            if viewModel.isPaused {
                                VStack(spacing: 10) {
                                    HStack {
                                        Button(action: {
                                            ButtonSoundPlayer.shared.play(soundName: "click2")
                                            viewModel.resumeMeasurement()
                                        }) {
                                            Text(languageManager.localizedString(for: "resumeMeasurement"))
                                                .font(.custom("Kazesawa-Bold", size: 30))
                                                .frame(maxWidth: .infinity, minHeight: 44)
                                                .padding()
                                                .background(Color.blue)
                                                .foregroundColor(.white)
                                                .cornerRadius(10)
                                        }
                                        
                                        Button(action: {
                                            ButtonSoundPlayer.shared.play(soundName: "click2")
                                            viewModel.resetMeasurement()
                                        }) {
                                            Text(languageManager.localizedString(for: "reset"))
                                                .font(.custom("Kazesawa-Bold", size: 30))
                                                .frame(maxWidth: .infinity, minHeight: 44)
                                                .padding()
                                                .background(Color.red)
                                                .foregroundColor(.white)
                                                .cornerRadius(10)
                                        }
                                    }
                                    .padding(.horizontal)
                                    
                                    //ï¼ˆå¿…è¦ãªã‚‰CSVãƒœã‚¿ãƒ³ï¼‰
                                    if viewModel.isFileSaveButtonVisible {
                                        Button(action: {
                                            ButtonSoundPlayer.shared.play(soundName: "click1")
                                            exportCSV()
                                        }) {
                                            Text(languageManager.localizedString(for: "exportCSV"))
                                                .font(.custom("Kazesawa-Bold", size: 30))
                                                .frame(maxWidth: .infinity, minHeight: 44)
                                                .padding()
                                                .background(Color.green)
                                                .foregroundColor(.white)
                                                .cornerRadius(10)
                                        }
                                        .padding(.horizontal)
                                    }
                                    
                                    Spacer()
                                    
                                    // ä¸‹éƒ¨ãƒãƒŠãƒ¼ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
                                    AdBannerView(adUnitID: "ca-app-pub-7266216351091418/5813852816")
                                        .frame(maxWidth: .infinity)
                                        .frame(height: 65)
                                        .padding(.bottom, 0)
                                }
                            }
                        }
                    }
                }
            }
            
            .sheet(isPresented: $isSettingsPresented) {
                SettingsView(viewModel: viewModel)
                    .environmentObject(languageManager)
            }
            .sheet(isPresented: $isUserGuidePresented) {
                UserGuideView() // PDFã‚’è¡¨ç¤º
            }
            .sheet(isPresented: $isSharing) {
                if let sharedURL = sharedURL {
                    ShareSheet(activityItems: [sharedURL])
                } else {
                    Text("ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                        .font(.custom("Kazesawa-Bold", size: 15))
                        .foregroundColor(.red)
                }
            }
            // .sheet(isPresented: $isSubscriptionPresented) { ... }  // â† å®Œå…¨å‰Šé™¤
            
            .onReceive(NotificationCenter.default.publisher(for: .flashScreen)) { _ in
                flashOpacity = 1.0
                DispatchQueue.main.asyncAfter(deadline: .now() + 0.1) {
                    flashOpacity = 0.0
                }
            }
            .onAppear {
                requestTrackingPermission()
            }
            .alert(isPresented: $viewModel.shouldShowAlert) {
                Alert(
                    title: Text(languageManager.localizedString(for: "alert"))
                        .font(.custom("Kazesawa-Bold", size: 30)),
                    message: Text(languageManager.localizedString(for: "alertMessage"))
                        .font(.custom("Kazesawa-Bold", size: 15)),
                    dismissButton: .default(Text(languageManager.localizedString(for: "ok"))
                        .font(.custom("Kazesawa-Bold", size: 30)))
                )
            }
        }
    }
        
    // çµŒéæ™‚é–“ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    func formattedElapsedTime(_ elapsedTime: Double) -> String {
        let minutes = Int(elapsedTime) / 60
        let seconds = Int(elapsedTime) % 60
        return String(format: "%02d:%02d", minutes, seconds)
    }
        
    // ã‚°ãƒ©ãƒ•ã®Xè»¸ç¯„å›²ã‚’è¨ˆç®—
    func getXScaleDomain() -> ClosedRange<Double> {
        let maxTime = viewModel.elapsedTime
        let minTime = max(0, maxTime - 300.0)
        return minTime...maxTime
    }
    
    // AccelerometerView.swift ã®æœ€å¾Œã® } ã®ä¸‹ã«è¿½åŠ 
    func requestTrackingPermission() {
        if #available(iOS 14, *) {
            ATTrackingManager.requestTrackingAuthorization { status in
                switch status {
                case .authorized:
                    print("âœ… ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°è¨±å¯ã•ã‚Œã¾ã—ãŸ")
                case .denied:
                    print("âŒ ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°æ‹’å¦ã•ã‚Œã¾ã—ãŸ")
                case .notDetermined:
                    print("â³ ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°æœªé¸æŠ")
                case .restricted:
                    print("ğŸš« ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™")
                @unknown default:
                    break
                }
            }
        }
    }
        
    // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
    func exportCSV() {
        let recentData = viewModel.accelerationData.filter { $0.time >= max(viewModel.elapsedTime - 300, 0) }
        
        guard !recentData.isEmpty else {
            print("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã§ãã¾ã›ã‚“ã€‚")
            return
        }
        
        let csvString = "æ™‚é–“,åŠ é€Ÿåº¦(Zè»¸)\n" + recentData.map { "\($0.time),\($0.z)" }.joined(separator: "\n")
        
        do {
            let dateFormatter = DateFormatter()
            dateFormatter.dateFormat = "yyyy-MM-dd_HH-mm-ss"
            let fileName = "acceleration_data_\(dateFormatter.string(from: Date())).csv"
            let fileURL = FileManager.default.temporaryDirectory.appendingPathComponent(fileName)
            try csvString.write(to: fileURL, atomically: true, encoding: .utf8)
            
            DispatchQueue.main.asyncAfter(deadline: .now() + 0.1) {
                self.sharedURL = fileURL
                self.isSharing = true
            }
        } catch {
            print("CSVãƒ•ã‚¡ã‚¤ãƒ«ã®æ›¸ãè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: \(error)")
        }
    }
}
